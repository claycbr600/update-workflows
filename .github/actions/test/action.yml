name: Close Issue

inputs:
  commit_sha:
    description: 'Commit sha of release tag'
    required: true
  token:
    description: 'Personal access token'
    required: true
  dry_run:
    description: 'Only print issues to close'
    type: boolean
    required: false
    default: false

runs:
  using: composite

  steps:
    - name: Get release tag from commit
      uses: actions/github-script@v5
      id: release-tag
      with:
        result-encoding: string
        script: |
          const commit_sha = "${{ inputs.commit_sha }}"
          const resp = await github.rest.repos.listTags({
            owner: context.repo.owner,
            repo: context.repo.repo
          })
          const tags = resp.data
          for (const tag of tags) {
            if (tag.commit.sha == commit_sha) {
              return tag.name
            }
          }

    - name: print release tag
      shell: bash
      run: echo "tag = ${{ steps.release-tag.outputs.result }}"

    - name: dry run param test
      if: inputs.dry_run
      shell: bash
      run: echo dry run here!

    - name: Close release issues
      uses: actions/github-script@v5
      id: issues
      with:
        github-token: ${{ inputs.token }}
        script: |
          const tag = "${{ steps.release-tag.outputs.result }}"
          const dry_run = ${{ inputs.dry_run }}
          console.log(`dry_run = ${dry_run}`)
          const resp = await github.rest.repos.getReleaseByTag({
            owner: context.repo.owner,
            repo: context.repo.repo,
            tag: tag
          })
          const body = resp.data.body
          const regexp = /intellum\/[\w-]+\/issues\/\d+/g
          const issues = [...body.matchAll(regexp)].map(e => e[0])
          for (let issue of issues) {
            issue = issue.split('/')
            let repo = issue[1]
            let issue_number = issue[3]
            console.log(`closing issue intellum/${repo}#${issue_number}`)
            if (dry_run) {
              continue
            }
            github.rest.issues.update({
              owner: context.repo.owner,
              repo: repo,
              issue_number: issue_number,
              state: "closed"
            })
          }
